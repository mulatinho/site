<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- social -->
  <meta property="twitter:site" content="https://mulatinho.net/2017/01/27/devops-ansible-basics.html" />
  <meta property="og:url" content="https://mulatinho.net/2017/01/27/devops-ansible-basics.html" />

  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />

  <!-- title -->
  <title>DevOps: Ansible Basics</title>
  <meta property="og:title" content="DevOps: Ansible Basics" />
  <meta name="twitter:title" content="DevOps: Ansible Basics" />
  <meta property="og:site_name" content="Alexandre Mulatinho">

  <meta name='author' content='Alexandre Mulatinho' />
  <meta name='keywords' content='blog, mulatinho, open source, software livre, linux, solutions, tech' />

  <meta name="description" content="A blog about an brazilian software developer and systems manager who talks about technology, personal life, linux, open source, systems and app development">
  <meta property="og:description" content="A blog about an brazilian software developer and systems manager who talks about technology, personal life, linux, open source, systems and app development">
  <meta name="twitter:description" content="A blog about an brazilian software developer and systems manager who talks about technology, personal life, linux, open source, systems and app development" />

  
    <meta property="og:image" content="https://mulatinho.files.wordpress.com/2017/07/img_20170322_140523390.jpg">
    <meta property="twitter:image" content="https://mulatinho.files.wordpress.com/2017/07/img_20170322_140523390.jpg">
  

  <meta name="twitter:creator" content="@alexmulatinho" />

  <meta name="description" content="Ansible is one of the best tools in DevOps that I like, he just need a simply configuration and can help you with a lot of tasks in your day by day on your i...">
  <meta http-equiv="refresh" content="300" />

  <link rel="stylesheet" href="/assets/main.css">

  <link rel="canonical" href="https://mulatinho.net/">
  <link rel="alternate" type="application/rss+xml" title="Alexandre Mulatinho" href="/feed.xml">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:700|Montserrat|Abel|Muli|Acme" rel="stylesheet" />


  
</head>


  <body>

    <header class="site-header" role="banner">

  <br/>
  <br/>

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Alexandre Mulatinho</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/blog/">Blog</a>
            
          
            
            
            <a class="page-link" href="/docs/">Best of Articles</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">DevOps: Ansible Basics</h1>
    <p class="post-meta">
      <time datetime="2017-01-27T00:00:00-03:00" itemprop="datePublished">
        
        Fri, Jan 27, 2017
      </time>
      </p>
  </header>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- mulato-blog -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5138819533079914"
     data-ad-slot="8675679252"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

  <br />
  <br />

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://docs.ansible.com">Ansible</a> is one of the best tools in DevOps that I like, he just need a simply configuration and can help you with a lot of tasks in your day by day on your infrastructure, today I will show to you how to configure him to work with a lot of servers and how to automate some simple tasks.</p>

<h3 id="advantages-of-ansible">Advantages of Ansible</h3>

<ul>
  <li>Easy to use and fast response</li>
  <li>Highly configurable to almost every task you need to do</li>
  <li>SSH based, just use <strong>ssh-keygen, ssh-copy-id</strong> and <strong>ssh-add</strong></li>
  <li>Free software sponsored by Red Hat</li>
  <li>Playbooks to make complex tasks</li>
</ul>

<h3 id="so-how-we-begin-use-this-tool">So how we begin use this tool?</h3>

<p>The very first thing you need to do is obviously install Ansible on your system. You can do this by typing on linux</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># yum install ansible # (redhat)
# apt-get install ansible # (debian/ubuntu)
</code></pre></div></div>

<p>Or on your OSX:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ /usr/bin/ruby -e "$(curl -fsSL \
https://raw.githubusercontent.com/Homebrew/install/master/install)"
$ brew install ansible
</code></pre></div></div>

<h3 id="the-inventory-file">The inventory file</h3>

<p>Ansible needs a file to specify all servers you want to control, you can use a tag name to make an group  to all servers you want by category, below we set two groups: <strong>appservers</strong> and <strong>databases</strong>, note that you don’t need to specify one by one in a line, you can use regex to simplify (this is awesome!)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[appservers]
staging1.dev.yourcompany.com
staging2.dev.yourcompany.com
staging3.dev.yourcompany.com

[databases]
db[1:5].dev.yourcompany.com
</code></pre></div></div>

<p>After that, or perhaps before that, as told before Ansible needs a SSH master key that need to be added on <strong>/.ssh/authorize_keys</strong> file into each of your slave servers, to do that you just need to proceed like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ssh-keygen -t rsa # (to generate your key, enter until finish)
</code></pre></div></div>

<p>And you will get a <strong>~/.ssh/id_rsa.pub</strong> public key file in your <strong>$HOME</strong> directory; So now you need to distribute your public-key to all servers you need control, this can be easy if you have only ten servers to administer or a pain if you have to do this in more than 100+ servers, so here’s a tip:</p>

<ul>
  <li>
    <p>Create a file with all your servers like this:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  root@server1.dev.company.com
  root@server2.dev.company.com
</code></pre></div>    </div>

    <p>(I will not show to you how to make this with inventory file as input, but you can!)</p>
  </li>
  <li>
    <p>Use this command-line to copy your keys to each server and insert root-password</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ while read LINE; do ssh-copy-id $LINE; done &lt; /tmp/servers
</code></pre></div>    </div>
  </li>
  <li>
    <p>Using Ansible in command-line</p>
  </li>
</ul>

<p>All set? So lets try do something really cool here. This is the most basic syntax of ansible:</p>

<p><strong>$ ansible :target: -i inventory-file :actions:</strong></p>

<p>Where <strong>:target:</strong> is the group of servers in your inventory file or just an string <strong>all</strong> to contemplate all servers in your inventory, the <strong>:actions:</strong> can be a simply command like below or a more complex command-line using ansible modules.</p>

<h4 id="get-all-kernel-versions-of-our-servers">Get all kernel versions of our servers</h4>

<p><strong>$ ansible all -i yourcompany.conf -u root -a “uname -a”</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>staging1.dev.yourcompany.com | SUCCESS | rc=0 &gt;&gt;
Linux staging1.dev 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux

staging3.dev.yourcompany.com | SUCCESS | rc=0 &gt;&gt;
Linux staging3.dev 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux

db2.dev.yourcompany.com | SUCCESS | rc=0 &gt;&gt;
Linux db2.dev 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux

staging2.dev.yourcompany.com | SUCCESS | rc=0 &gt;&gt;
Linux staging2.dev.yourcompany.com 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
(Note that all servers responded with your kernel)
</code></pre></div></div>

<h4 id="use-a-default-module-ping-to-check-if-databasesare-alive">Use a default module <strong>ping</strong> to check if databases are alive</h4>

<p><strong>$ ansible databases -i yourcompany.conf -m ping</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1.dev.yourcompany.com | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}
db2.dev.yourcompany.com | SUCCESS =&gt; {
    "changed": false,
    "ping": "pong"
}
....
</code></pre></div></div>

<h4 id="use-a-default-module-apt-to-install-a-mysql-database">Use a default module <strong>apt</strong> to install a mysql database</h4>

<p><strong>$ ansible databases -i yourcompany.conf \
-m apt -a “name=mysql-server state=latest”</strong></p>

<h3 id="so-how-can-i-know-what-modules-are-available">So how can I know what modules are available?</h3>

<p>They are listed here -&gt;
<a href="http://docs.ansible.com/ansible/list_of_all_modules.html">http://docs.ansible.com/ansible/list_of_all_modules.html</a></p>

<h3 id="playbooks-the-real-thing">Playbooks: The real thing</h3>

<p>Okay, now you know that you can send commands and use modules to process in all your servers with just one command line, thats cool! But what really amazing in Ansible are the playbooks! A playbook is just a file with a template engine called <a href="http://yaml.org">YAML</a> and
<a href="http://jinja.pocoo.org/docs/2.9/templates/#builtin-filters">Jinja</a> to apply some filters, variables and others, with that you can do a lot of automate complex tasks in your servers. Lets take a look into a sample file called ‘<strong>install_apache.yml</strong>’:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
- hosts: appservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  - name: install or upgrade apache to latest version
    yum: name=httpd state=latest
  - name: write the apache config file
    template: src=./httpd.j2 dest=/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running (and enable it at boot)
    service: name=httpd state=started enabled=yes
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
</code></pre></div></div>

<ul>
  <li><strong>hosts</strong> -&gt; means that all these tasks will only be executed in the group defined after the word, here
<strong>appservers,</strong> defined by our inventory file in the begin of this post.</li>
  <li><strong>vars</strong> -&gt; are variables you define to process tasks with it, note that variables are defined line by line.</li>
  <li><strong>remote_user</strong> -&gt; another way to use <strong>-u root</strong> without need to put in cmd.</li>
  <li><strong>name</strong> -&gt; is just a name you define to implement a task</li>
  <li><strong>template</strong> -&gt; in this case is just a way to say, copy my source file defined as ./httpd.j2 to destination server on /etc/httpd.conf</li>
  <li><strong>notify</strong> -&gt; is a tag that call a job (<strong>restart apache</strong>) in handlers block at the end of execution of the current block</li>
</ul>

<p>Or, to resume this playbook will:</p>

<ul>
  <li>Install the latest version of httpd apache on all your <strong>appservers</strong>
*Copy your local <strong>httpd.j2</strong> file to remote server on <strong>/etc/httpd.conf</strong></li>
  <li>Put your variables where you set in <strong>httpd.j2</strong> file</li>
  <li>Restart apache after that</li>
  <li>Set apache to run automatically after a boot/reboot</li>
</ul>

<p>As you see you can do a lot with this, without this you would need to enter in each server and make these tasks one by one without any human mistake, with ansible you just need to type this:</p>

<p><strong>$ ansible-playbook -i yourcompany.conf install_apache.yml</strong></p>

<p>On next time we will show to you how to do more complex examples, best practices and directory structure to help on your day tasks.</p>

<p>Thats it for now! What are you waiting for? Use ansible to automate your tasks now!! :)</p>

  </div>

  
    
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://mulatinho.net/2017/01/27/devops-ansible-basics.html';
      this.page.identifier = 'https://mulatinho.net/2017/01/27/devops-ansible-basics.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://mulatinho.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  
</article>

      </div>
    </main>

    <br />
<footer class="site-footer">

  <div class="wrapper">

      <p>A blog about an brazilian software developer and systems manager who talks about technology, personal life, linux, open source, systems and app development</p>

      <br/>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- mulato-blog -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5138819533079914"
     data-ad-slot="8675679252"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


  </div>

</footer>


  </body>

</html>
